# FileShare 系统架构与模块说明文档

## 一、系统概述

FileShare 是一个面向10-50人小团队的文件共享系统，采用前后端分离架构，支持私有服务器部署。

### 技术栈
- **后端**: Node.js + Express + SQLite
- **前端**: React + TypeScript + Vite + Ant Design
- **数据库**: SQLite3
- **文件存储**: 本地文件系统（支持加密）

## 二、系统架构图

```
┌─────────────────────────────────────────────────────────┐
│                     客户端层                              │
├─────────────────────────────────────────────────────────┤
│  网页端 (React)  │  桌面客户端 (Electron)  │  移动端 (RN) │
└─────────────────────────────────────────────────────────┘
                            │
                    HTTP/HTTPS API
                            │
┌─────────────────────────────────────────────────────────┐
│                     应用服务层                           │
├─────────────────────────────────────────────────────────┤
│  Express 服务器                                          │
│  ├── 路由层 (Routes)                                     │
│  ├── 中间件层 (Middleware)                               │
│  ├── 业务逻辑层 (Services)                               │
│  └── 工具层 (Utils)                                      │
└─────────────────────────────────────────────────────────┘
                            │
┌─────────────────────────────────────────────────────────┐
│                     数据存储层                           │
├─────────────────────────────────────────────────────────┤
│  SQLite 数据库  │  文件存储系统  │  日志系统             │
└─────────────────────────────────────────────────────────┘
```

## 三、核心模块说明

### 1. 用户认证模块 (auth)

**位置**: `server/routes/auth.js`, `server/middleware/auth.js`

**功能**:
- 用户注册/登录
- JWT Token 认证
- 密码修改
- 预留第三方登录接口

**与其他模块的关系**:
- 所有需要认证的接口都依赖此模块
- 通过中间件 `authenticate` 验证用户身份
- 用户信息存储在 `users` 表

**数据流**:
```
用户登录 → 验证账号密码 → 生成JWT Token → 返回Token
后续请求 → 携带Token → 验证Token → 获取用户信息 → 执行业务逻辑
```

### 2. 用户管理模块 (users)

**位置**: `server/routes/users.js`, `client/src/pages/Admin.tsx`

**功能**:
- 用户列表查询
- 创建新用户（管理员）
- 修改用户信息
- 启用/禁用用户
- 撤销用户权限

**与其他模块的关系**:
- 依赖认证模块（需要管理员权限）
- 操作结果记录到日志模块
- 用户信息影响权限模块的判断

**权限控制**:
- 只有管理员可以访问用户管理功能
- 通过 `requireAdmin` 中间件保护

### 3. 文件管理模块 (files)

**位置**: `server/routes/files.js`, `client/src/pages/Files.tsx`

**功能**:
- 文件上传（支持大文件、断点续传）
- 文件下载（支持选择保存路径）
- 文件列表查询
- 文件重命名/删除
- 文件版本管理

**与其他模块的关系**:
- 依赖认证模块（需要登录）
- 依赖权限模块（检查文件访问权限）
- 依赖加密模块（文件加密存储）
- 依赖日志模块（记录操作）
- 文件信息存储在 `files` 表
- 文件版本存储在 `file_versions` 表

**数据流**:
```
上传: 文件 → Multer接收 → 权限检查 → 加密处理 → 保存到存储 → 记录到数据库
下载: 请求文件 → 权限检查 → 读取文件 → 解密处理 → 返回给客户端
```

### 4. 空间管理模块 (spaces)

**位置**: `server/routes/spaces.js`, `client/src/pages/Spaces.tsx`

**功能**:
- 创建空间（团队/部门/个人/项目）
- 空间列表查询
- 空间详情查看
- 创建文件夹

**与其他模块的关系**:
- 依赖认证模块
- 依赖权限模块（空间访问权限）
- 文件可以关联到空间（`files.space_id`）
- 文件夹属于空间（`folders.space_id`）

**空间类型**:
- **团队空间**: 所有成员可见，管理员创建
- **部门空间**: 部门成员可见，管理员创建
- **个人空间**: 仅自己可见，所有用户可创建
- **项目空间**: 项目成员可见，所有用户可创建

**空间成员关联机制**:

空间与成员的关联通过以下方式实现：

1. **空间所有者**（直接关联）
   - `spaces.owner_id` → `users.id`
   - 创建空间时自动设置为所有者
   - 所有者自动拥有所有权限

2. **权限表关联**（普通成员）
   - `permissions` 表中 `resource_type='space'` 的记录
   - `resource_id` = 空间ID，`user_id` = 用户ID
   - 支持设置多种权限类型（read/write/delete/comment/download）

3. **用户组关联**（批量授权）
   - `permissions` 表中 `group_id` 关联到用户组
   - `user_group_members` 表关联用户到用户组
   - 用户组成员自动继承组权限

**成员管理功能**:
- 添加成员：为空间添加用户并设置权限
- 查看成员：查看空间所有成员及其权限
- 移除成员：移除空间成员及其权限

### 5. 权限控制模块 (permissions)

**位置**: `server/routes/permissions.js`, `server/middleware/auth.js`

**功能**:
- 设置文件/文件夹/空间的权限
- 权限检查（read/write/delete/comment/download）
- 用户组权限管理

**权限类型**:
- **read**: 读取权限（查看、下载）
- **write**: 写入权限（上传、修改）
- **delete**: 删除权限
- **comment**: 评论权限
- **download**: 下载权限（可单独控制）

**权限检查逻辑**:
```
1. 管理员 → 拥有所有权限
2. 资源所有者（创建者）→ 拥有所有权限
3. 直接权限 → 检查 permissions 表
4. 用户组权限 → 检查用户组关联的权限
5. 默认 → 无权限
```

**与其他模块的关系**:
- 被所有资源访问模块调用
- 权限信息存储在 `permissions` 表
- 用户组信息存储在 `user_groups` 和 `user_group_members` 表

### 6. 文件分享模块 (shares)

**位置**: `server/routes/shares.js`

**功能**:
- 创建外部分享链接
- 分享链接访问验证
- 分享访问记录
- 撤销分享

**分享配置**:
- 访问密码（可选）
- 允许邮箱列表（可选）
- 有效期设置（7天/30天/自定义）

**与其他模块的关系**:
- 依赖认证模块（创建分享需要登录）
- 依赖权限模块（检查分享权限）
- 分享信息存储在 `external_shares` 表
- 访问记录存储在 `share_access_logs` 表

### 7. 评论模块 (comments)

**位置**: `server/routes/comments.js`

**功能**:
- 添加文件评论
- @成员提醒
- 查看评论列表
- 删除评论

**与其他模块的关系**:
- 依赖认证模块
- 依赖权限模块（需要 comment 权限）
- 评论信息存储在 `comments` 表
- 支持回复评论（parent_id）

### 8. 搜索模块 (search)

**位置**: `server/routes/search.js`

**功能**:
- 多条件组合搜索
- 关键词模糊搜索
- 结果按相关性排序

**搜索条件**:
- 文件名/关键词
- 文件类型
- 上传时间范围
- 上传人
- 所属空间

**与其他模块的关系**:
- 依赖认证模块
- 依赖权限模块（只返回有权限的文件）
- 查询 `files` 表

### 9. 加密模块 (encryption)

**位置**: `server/utils/encryption.js`

**功能**:
- 文件加密/解密
- 支持多种加密模式
- 文件哈希生成
- Token 生成

**加密模式**:
- **none/plain**: 明文存储（默认）
- **sm4**: SM4 国密算法加密
- **aes256**: AES-256 加密
- **external**: 外部 SDK 加密

**与其他模块的关系**:
- 被文件管理模块调用
- 文件上传时加密，下载时解密
- 加密密钥存储在环境变量中

### 10. 日志模块 (logger)

**位置**: `server/utils/logger.js`, `server/routes/logs.js`

**功能**:
- 记录所有用户操作
- 日志查询和导出
- 自动清理过期日志

**记录内容**:
- 操作人、操作时间
- 操作类型、资源类型、资源ID
- 操作详情、IP地址、User-Agent

**与其他模块的关系**:
- 被所有业务模块调用
- 日志信息存储在 `operation_logs` 表
- 管理员可以查看和导出日志

### 11. 管理后台模块 (admin)

**位置**: `server/routes/admin.js`, `client/src/pages/Admin.tsx`

**功能**:
- 系统统计信息
- 系统配置管理
- 清理回收站
- 清理过期版本

**与其他模块的关系**:
- 依赖认证模块（需要管理员权限）
- 查询多个模块的数据进行统计
- 管理系统配置表 `system_config`

## 四、数据库设计

### 核心表关系

```
users (用户表)
  ├── files.created_by (文件创建者)
  ├── files.updated_by (文件更新者)
  ├── spaces.owner_id (空间所有者)
  ├── folders.created_by (文件夹创建者)
  └── permissions.user_id (权限用户)

spaces (空间表)
  ├── files.space_id (文件所属空间)
  └── folders.space_id (文件夹所属空间)

files (文件表)
  ├── file_versions.file_id (文件版本)
  ├── comments.file_id (文件评论)
  └── permissions.resource_id (文件权限)

folders (文件夹表)
  ├── files.folder_id (文件所属文件夹)
  └── folders.parent_id (父文件夹)

permissions (权限表)
  ├── permissions.user_id (用户权限)
  └── permissions.group_id (用户组权限)

user_groups (用户组表)
  └── user_group_members.group_id (组成员)
```

### 数据流向

```
用户操作 → 认证验证 → 权限检查 → 业务处理 → 数据存储 → 日志记录
```

## 五、模块间调用关系

### 1. 认证流程
```
客户端请求 → authenticate 中间件 → 验证Token → 获取用户信息 → 附加到req.user → 业务处理
```

### 2. 文件上传流程
```
客户端上传 → authenticate → 权限检查 → 文件接收 → 加密处理 → 保存文件 → 数据库记录 → 日志记录
```

### 3. 文件下载流程
```
客户端请求 → authenticate → 权限检查 → 读取文件 → 解密处理 → 返回文件
```

### 4. 权限检查流程
```
权限检查请求 → 检查管理员 → 检查资源所有者 → 检查直接权限 → 检查用户组权限 → 返回结果
```

## 六、API 接口设计

### RESTful 设计原则

- **GET**: 查询资源
- **POST**: 创建资源
- **PATCH**: 更新资源（部分字段）
- **DELETE**: 删除资源

### 接口列表

| 模块 | 接口 | 方法 | 说明 |
|------|------|------|------|
| 认证 | `/api/auth/login` | POST | 用户登录 |
| 认证 | `/api/auth/register` | POST | 用户注册 |
| 认证 | `/api/auth/me` | GET | 获取当前用户信息 |
| 用户 | `/api/users` | GET | 获取用户列表（管理员） |
| 用户 | `/api/users` | POST | 创建用户（管理员） |
| 文件 | `/api/files/upload` | POST | 上传文件 |
| 文件 | `/api/files/download/:fileId` | GET | 下载文件 |
| 文件 | `/api/files/list` | GET | 获取文件列表 |
| 文件 | `/api/files/:fileId` | DELETE | 删除文件 |
| 空间 | `/api/spaces` | GET | 获取空间列表 |
| 空间 | `/api/spaces` | POST | 创建空间 |
| 权限 | `/api/permissions` | POST | 设置权限 |
| 分享 | `/api/shares` | POST | 创建分享 |
| 搜索 | `/api/search` | GET | 搜索文件 |
| 日志 | `/api/logs` | GET | 获取操作日志 |

## 七、安全机制

### 1. 认证安全
- JWT Token 认证
- Token 过期机制
- 密码 bcrypt 加密

### 2. 权限安全
- 多级权限检查
- 资源所有者自动拥有权限
- 管理员拥有所有权限

### 3. 文件安全
- 支持文件加密存储（SM4/AES-256）
- HTTPS 传输加密
- 文件访问权限控制

### 4. 操作审计
- 详细的操作日志
- 90天日志保留
- 支持日志导出

## 八、性能优化

### 1. 数据库优化
- 索引优化（文件、权限、日志）
- 查询优化（分页、条件过滤）

### 2. 文件处理优化
- 大文件支持（10GB+）
- 流式处理
- 异步加密/解密

### 3. 前端优化
- React Query 缓存
- 分页加载
- 懒加载

## 九、扩展性设计

### 1. 存储扩展
- 支持外部 SDK 加密
- 预留对象存储接口
- 支持存储空间扩容

### 2. 功能扩展
- 预留第三方登录接口
- 预留 API 集成接口
- 模块化设计，易于扩展

## 十、部署架构

### 单机部署
```
┌─────────────────┐
│   Nginx/反向代理 │
└────────┬────────┘
         │
┌────────┴────────┐
│  Node.js 服务器 │
│  ┌──────────┐  │
│  │ Express  │  │
│  └──────────┘  │
│  ┌──────────┐  │
│  │ SQLite   │  │
│  └──────────┘  │
│  ┌──────────┐  │
│  │ 文件存储  │  │
│  └──────────┘  │
└────────────────┘
```

### 分布式部署（未来扩展）
```
┌─────────┐     ┌─────────┐     ┌─────────┐
│ 负载均衡 │ →  │ 应用服务器 │ →  │ 数据库集群 │
└─────────┘     └─────────┘     └─────────┘
                       │
                ┌──────┴──────┐
                │  对象存储   │
                └────────────┘
```

## 十一、故障排查

### 常见问题

1. **文件上传失败**
   - 检查存储目录权限
   - 检查磁盘空间
   - 查看服务器日志

2. **权限问题**
   - 检查用户角色
   - 检查权限表记录
   - 确认资源所有者

3. **数据库错误**
   - 检查数据库文件权限
   - 检查表结构
   - 查看错误日志

## 十二、开发规范

### 代码组织
- 按功能模块组织代码
- 统一的错误处理
- 统一的响应格式

### 命名规范
- 路由：RESTful 风格
- 函数：驼峰命名
- 数据库：下划线命名

### 注释规范
- 关键函数添加注释
- API 接口说明
- 复杂逻辑说明

